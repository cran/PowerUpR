---
title: "PowerUpR Vignettes"
author: "Metin Bulus & Nianbo Dong"
date: "November 2, 2016"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


# Problem
Institue of Education Science (IES) reported that evidence on effectiveness of Saxon Math curriclum on secondary school student's algebra subject is lacking and further research is needed (U.S. Department of Education, 2016). To evaluate the effectiveness Saxon Math curriculum, assume a 3-Level cluster randomized trial is considered where schools are randomly assigned to treatment (Saxon Math curriclum) and a control condition. In the grant proposal number of schools, teachers, and students, and the cost associated with data collection from this sample needs to be justified. We will use [`PowerUpR`](https://github.com/metinbulus/PowerUpR) package (Bulus & Dong, 2016) an implementation of [*PowerUp!*](http://www.causalevaluation.org) (Dong & Maynard, 2013) software in R environment. 

Consider the following hypothetical design parameters

- Proportion of variance in algebra posttest at the school level ($\sigma_3^2$): $.15$
- Proportion of variance in algebra posttest at the classroom level ($\sigma_2^2$):  $.05$
- Proportion of variance in algebra posttest at the student level ($\sigma_1^2$): $.65$
- Proportion of variance in algebra posttest explained by school mean algebra pretest: ($R_3^2$):  $.45$
- Proportion of variance in algebra posttest explained by classroom mean algebra pretest: ($R_2^2$): $.50$
- Proportion of variance in algebra posttest explained by student algebra pretest: ($R_1^2$): $.55$

Then, intraclass correlation coefficients are

  - $\rho_2 = \sigma_2^2 / (\sigma_1^2 + \sigma_2^2 + \sigma_3^2) = .05 /(.65 + .15 + .05) = 0.059$ 
  - $\rho_3 = \sigma_3^2 / (\sigma_1^2 + \sigma_2^2 + \sigma_3^2) = .15 /(.65 + .15 + .05) = 0.176$ 
  
  
Further define

- Alpha level ($\alpha$): $0.05$
- Proportion of schools allocated to treatment ($P$): $.40$


# Scenario 1: Find MDES
Further assumptions 

- Number of schools ($K$): $83$
- Average number of classrooms per school ($J$): $2$
- Average number of students per classroom ($n$) : $10$
- Statistical power ($1-\beta$): $.80$ 

Given design parameters and further assumptions, what is minimum detectable effect size?
```{r, message=FALSE}
library(PowerUpR)
```

```{r, message=FALSE}
design1 <- mdes.cra3r3(power=.80, rho2=.06, rho3=.18,
                       g3=1, R12=.55, R22=.50, R32=.45,
                       P=.40, n=10, J=2, K=83)
print(design1$mdes)
```

# Scenario 2: Find Statistical Power
Further assumptions 

- Number of schools ($K$): $60$
- Average number of classrooms per school ($J$): $2$
- Average number of students per classroom ($n$) : $10$
- Minimum detectable effect size (MDES): $.232$

Given design parameters and further assumptions, what is statistical power?

```{r, message=FALSE}
design2 <- power.cra3r3(mdes=.23, rho2=.06, rho3=.18,
                        g3=1, R12=.55, R22=.50, R32=.45,
                        P=.40, n=10, J=2, K=83)
print(design2$power)
```

# Scenario 3: Find MRSS for Schools (K)
Further assumptions 

- Average number of classrooms per school ($J$): $2$
- Average number of students per classroom ($n$) : $10$
- Statistical power ($1-\beta$): $.80$ 
- Minimum detectable effect size (MDES): $.232$

Given design parameters and further assumptions, how many schools should be recruited?

```{r, message=FALSE}
design3 <- mrss.cra3r3(power=.80, mdes=.23, rho2=.06, rho3=.18,
                       g3=1, R12=.55, R22=.50, R32=.45,
                       P=.40, n=10, J=2)
print(design3$round.mrss)
```

# Scenario 4: Find MRSS for Classrooms (J)
Further assumptions 

- Number of schools ($K$): $60$
- Average number of students per classroom ($n$) : $10$
- Statistical power ($1-\beta$): $.80$ 
- Minimum detectable effect size (MDES): $.232$

Given design parameters and further assumptions, how many classrooms should be recruited per school on average?

```{r, message=FALSE}
design4 <- mrss.cra3r3(power=.80, mdes=.23, rho2=.06, rho3=.18,
                       g3=1, R12=.55, R22=.50, R32=.45,
                       P=.40, n=10, K=83)
print(design4$round.mrss)
```

# Scenario 5: Find MRSS for Students (n)
Further assumptions 

  - Number of schools ($K$): $60$
  - Average number of classrooms per school ($J$): $2$
  - Statistical power ($1-\beta$): $.80$ 
  - Minimum detectable effect size (MDES): $.232$
  
Given design parameters and further assumptions, how many studetns should be recruited per classroom on average?

```{r, message=FALSE}
design5 <- mrss.cra3r3(power=.80, mdes=.23, rho2=.06, rho3=.18,
                       g3=1, R12=.55, R22=.50, R32=.45,
                       P=.40, J=2, K=83)
print(design5$round.mrss)
```

# Scenario 6: Find Optimal Sample (Constrain Power)
Further assumptions 

  - Statistical power ($1-\beta$): $.80$ 
  - Minimum detectable effect size (MDES): $.232$
  - Marginal cost per student ($cn$): $10$
  - Marginal cost per classroom ($cJ$): $200$
  - Marginal cost per school ($cK$): $500$
  
  
Given design parameters and further assumptions, how many schools, classrooms and students should be recruited to achieve 80% power while minimizing the total cost?

```{r, message=FALSE}
design6 <- optimal.cra3r3(cn=10, cJ=200, cK=500, constrain="power", power=.80, 
                          mdes=.23, rho2=.06, rho3=.18,
                          g3=1, R12=.55, R22=.50, R32=.45,
                          P=.40)
print(design6$round.optim)
print(design6$integer.optim)
```
Note that MDES values in the output are calculated at the specified power value (.80), and power values in the output are
calculated at the specified MDES value (.23). 

# Scenario 7: Find Optimal Sample (Constrain Power and Number of Classrooms)
Further assumptions 

  - Statistical power ($1-\beta$): $.80$ 
  - Minimum detectable effect size (MDES): $.232$
  - Average number of classrooms per school ($J$): $2$
  - Marginal cost per student ($cn$): $10$
  - Marginal cost per classroom ($cJ$): $200$
  - Marginal cost per school ($cK$): $500$
  
Given design parameters and further assumptions, how many schools, and students should be recrutied to achieve 80% power while minimizing the total cost?

```{r, message=FALSE}
design7 <- optimal.cra3r3(cn=10, cJ=200, cK=500, constrain="power", power=.80, J=2, 
                          mdes=.23, rho2=.06, rho3=.18,
                          g3=1, R12=.55, R22=.50, R32=.45,
                          P=.40)
print(design7$round.optim)
print(design7$integer.optim)
```
Note that MDES values in the output are calculated at the specified power value (.80), and power values in the output are
calculated at the specified MDES value (.23). 

# Scenario 8: Find Optimal Sample (Constrain MDES and Number of Classrooms)
Further assumptions 

  - Statistical power ($1-\beta$): $.80$ 
  - Minimum detectable effect size (MDES): $.20$
  - Average number of classrooms per school ($J$): $2$
  - Marginal cost per student ($cn$): $10$
  - Marginal cost per classroom ($cJ$): $200$
  - Marginal cost per school ($cK$): $500$
  
  
Given design parameters and further assumptions, how many schools, and students should be recruited to achieve an MDES of .20 while minimizing the total cost?

```{r, message=FALSE}
design8 <- optimal.cra3r3(cn=10, cJ=200, cK=500, constrain="mdes", mdes=.20, J=2,
                          power=.80, rho2=.06, rho3=.18,
                          g3=1, R12=.55, R22=.50, R32=.45,
                          P=.40)
print(design8$round.optim)
print(design8$integer.optim)
```
Note that MDES values in the output are calculated at the specified power value (.80), and power values in the output are
calculated at the specified MDES value (.20). 

# Scenario 9: Find Optimal Sample (Constrain Cost and Number of Classrooms)
Further assumptions 

  - Statistical power ($1-\beta$): $.80$ 
  - Minimum detectable effect size (MDES): $.20$
  - Average number of classrooms per school ($J$): $2$
  - Marginal cost per student ($cn$): $10$
  - Marginal cost per classroom ($cJ$): $200$
  - Marginal cost per school ($cK$): $500$
  - Budget: $100,000$
  
Given design parameters and further assumptions, how many schools, and students should be recruited while maximizing the power?

```{r, message=FALSE}
design9 <- optimal.cra3r3(cn=10, cJ=200, cK=500, constrain="cost", cost=100000, J=2,
                          power=.80, mdes=.20, rho2=.06, rho3=.18,
                          g3=1, R12=.55, R22=.50, R32=.45,
                          P=.40)
print(design9$round.optim)
print(design9$integer.optim)
```
Note that MDES values in the output are calculated at the specified power value (.80), and power values in the output are
calculated at the specified MDES value (.20).  

# Scenario 10: Find Optimal Sample (Constrain Cost, Number of Classrooms, Number of Students)
Further assumptions 

  - Statistical power ($1-\beta$): $.80$ 
  - Minimum detectable effect size (MDES): $.20$
  - Average number of students per classroom ($J$): $20$
  - Average number of classrooms per school ($J$): $2$
  - Marginal cost per student ($cn$): $10$
  - Marginal cost per classroom ($cJ$): $200$
  - Marginal cost per school ($cK$): $500$
  - Budget: $100,000$
  
Given design parameters and further assumptions, how many schools should be recruited while maximizing the power?

```{r, message=FALSE}
design10 <- optimal.cra3r3(cn=10, cJ=200, cK=500, constrain="cost", cost=100000, n=20, J=2,
                           power=.80, mdes=.20, rho2=.06, rho3=.18,
                           g3=1, R12=.55, R22=.50, R32=.45,
                           P=.40)
print(design10$round.optim)
print(design10$integer.optim)

```
Note that MDES values in the output are calculated at the specified power value (.80), and power values in the output are
calculated at the specified MDES value (.20). 

# Plots
```{r, message=FALSE}
# Perspective plot
# Red point indicates the design location
plot(design10, type="p")
```

```{r, message=FALSE}
# Contour plot
# Red point indicates the design location
plot(design10, type="c")
```

```{r, message=FALSE}
# MDES - MRSS(K)
# Red point indicates the design location
plot(design10, pars=c("mdes","K"))
```

```{r, message=FALSE}
# Power - MRSS(K)
# Red point indicates the design location
plot(design10, pars=c("power","K"))
```

```{r, message=FALSE}
# Type I and Type II Error Rates
# Note: For didactic purpose
t1t2.error(design10)
```

# References
Bulus, M., & Dong, N. (2016).  `PowerUpR`: Power Analysis Tools for Individual/Cluster Randomized Trials. R package version 0.1.2.

Dong, N., & Maynard, R. A. (2013). PowerUp!: A Tool for Calculating Minum Detectable Effect Sizes and Minimum Required Sample Sizes
for Experimental and Quasi-Experimental Design Studies, *Journal of Research on Educational Effectiveness, 6(1)*, 24-6.

U.S. Department of Education, Institute of Education Sciences, What Works Clearinghouse. (2016, May).  Secondary Mathematics intervention report: Saxon Math. Retrieved from https://ies.ed.gov/ncee/wwc/Docs/InterventionReports/wwc_saxon_052416.pdf
